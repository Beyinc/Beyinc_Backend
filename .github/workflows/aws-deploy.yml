# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs
name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Archive build artifacts
        run: tar -czf build.tar.gz build package.json package-lock.json
        
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build/

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build/


  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-artifact
          path: .

      - name: Copy files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          source: "build.tar.gz"
          target: "~/apps/"

      - name: SSH into VM and deploy
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd ~/apps
            tar -xzf build.tar.gz -C ./app
            cd ./app
            npm install --only=production
            pm2 restart server || pm2 start server.js --name myapp










# name: Deploy

# on:
#   push:
#     branches: ["main"]

# jobs:
#   Deploy:
#     name: Deploy to EC2
#     runs-on: ubuntu-latest
#     environment: aws-deploy
#     steps:
#       - uses: actions/checkout@v3
#       - name: Build & Deploy
#         env:
#           PRIVATE_KEY: ${{secrets.AWS_SSH_KEY}}
#           HOSTNAME: ${{secrets.AWS_PUBLIC_KEY}}
#           PROD_ENV_FILE: ${{secrets.PROD_ENV_FILE}}

#         run: |
#           echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
#           ssh -o StrictHostKeyChecking=no -i private_key ubuntu@${HOSTNAME} '
#             sudo su -
#             curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
#             . ~/.nvm/nvm.sh
#             nvm install node
#             sudo apt install git -y
#             npm i -g pm2
#             rm -rf ./Beyinc_Backend
#             git clone https://github.com/Beyinc/Beyinc_Backend.git
#             cd ./Beyinc_Backend
#             npm i
#             touch config.env

#             echo PORT=${{ secrets.PORT }} >> config.env
#             echo API_KEY=${{ secrets.API_KEY }} >> config.env
#             echo BEYINC_SITE=${{ secrets.BEYINC_SITE }} >> config.env
#             echo ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }} >> config.env
#             echo ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }} >> config.env
#             echo REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }} >> config.env
#             echo MONGODB_URI=${{ secrets.MONGODB_URI }} >> config.env
#             echo EMAIL=${{ secrets.EMAIL }} >> config.env
#             echo EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }} >> config.env
#             echo CLOUDINARY_NAME=${{ secrets.CLOUDINARY_NAME }} >> config.env
#             echo CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} >> config.env
#             echo CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} >> config.env
#             echo TWILIO_ACCOUNTSID=${{ secrets.TWILIO_ACCOUNTSID }} >> config.env
#             echo TWILIO_AUTHTOKEN=${{ secrets.TWILIO_AUTHTOKEN }} >> config.env
#             echo TWILIO_PHONE=${{ secrets.TWILIO_PHONE }} >> config.env

#             echo RAZORPAY_APT_SECRET=${{ secrets.RAZORPAY_APT_SECRET }} >> config.env
#             echo RAZORPAY_API_KEY=${{ secrets.RAZORPAY_API_KEY }} >> config.env
#             echo YOUR_CLIENT_ID=${{ secrets.YOUR_CLIENT_ID }} >> config.env
#             echo YOUR_CLIENT_SECRET=${{ secrets.YOUR_CLIENT_SECRET }} >> config.env
#             echo YOUR_REDIRECT_URL=${{ secrets.YOUR_REDIRECT_URL }} >> config.env

#             pm2 delete beyinc-backend-api || : && pm2 start server.js --name 'beyinc-backend-api'
#             pm2 save
#               '


